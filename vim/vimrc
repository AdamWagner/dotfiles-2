" break away from old vi compatibility
set nocompatible
" clear all autocommands
autocmd!
" found vim config file and config dir
let s:vim_conf = expand('<sfile>:p')
let s:vim_dir = fnamemodify(s:vim_conf, ':h') . '/.vim'

" {{{ NeoBundle

let &runtimepath .= ',' . s:vim_dir . '/bundle/neobundle.vim'
if (exists("g:bundle_dir"))
  call neobundle#rc(g:bundle_dir) " load NeoBundle
else
  call neobundle#rc() " load NeoBundle
endif

" Load NeoBundle plugin first
NeoBundleFetch 'Shougo/neobundle.vim'

" Themes plugins
NeoBundle 'croaker/mustang-vim' "mustang
NeoBundle 'http://blog.toddwerth.com/entry_files/8/ir_black.vim', { 'name': 'ir_black.vim', 'script_type': 'colors' } "ir_black
NeoBundle 'wombat256.vim' "wombat256mod

" Languages plugins
NeoBundle '2072/PHP-Indenting-for-VIm'
NeoBundle 'othree/html5.vim'
NeoBundle 'pangloss/vim-javascript'
NeoBundle 'phpcomplete.vim'
NeoBundle 'tpope/vim-git'
NeoBundle 'tpope/vim-markdown'

" Tools plugins
NeoBundle 'Lokaltog/powerline', {'rtp': 'powerline/bindings/vim/'}
NeoBundle 'Lokaltog/vim-easymotion'
NeoBundle 'Shougo/neocomplcache.vim'
NeoBundle 'Shougo/neosnippet.vim'
NeoBundle 'Shougo/vimproc', {'build': {'mac': 'make -f make_mac.mak', 'unix' : 'make -f make_unix.mak'}}
NeoBundle 'a.vim'
NeoBundle 'abeaumet/ack.vim'
NeoBundle 'airblade/vim-rooter'
NeoBundle 'chrisbra/NrrwRgn'
NeoBundle 'closetag.vim'
NeoBundle 'godlygeek/tabular'
NeoBundle 'https://bitbucket.org/sjl/gundo.vim'
NeoBundle 'jeetsukumaran/vim-buffergator'
NeoBundle 'jimsei/winresizer'
NeoBundle 'kien/ctrlp.vim'
NeoBundle 'majutsushi/tagbar'
NeoBundle 'matchit.zip'
NeoBundle 'myusuf3/numbers.vim'
NeoBundle 'nelstrom/vim-visual-star-search'
NeoBundle 'scrooloose/nerdcommenter'
NeoBundle 'scrooloose/nerdtree'
NeoBundle 'scrooloose/syntastic'
NeoBundle 'terryma/vim-multiple-cursors'
NeoBundle 'tpope/vim-abolish'
NeoBundle 'tpope/vim-eunuch'
NeoBundle 'tpope/vim-fugitive'
NeoBundle 'tpope/vim-repeat'
NeoBundle 'tpope/vim-speeddating'
NeoBundle 'tpope/vim-surround'
NeoBundle 'tpope/vim-unimpaired'
NeoBundle 'tristen/vim-sparkup'
NeoBundle 'xolox/vim-easytags'
NeoBundle 'xolox/vim-misc'

NeoBundleCheck " check installation

" }}}

" {{{ File type / Syntax detection / Theme

syntax enable
filetype plugin indent on
set t_Co=256
set background=dark
silent! colorscheme wombat256mod
hi CursorLine cterm=bold

" }}}

" {{{ Functions

" https://github.com/EOL/cukestone/wiki/Vim-cleaning-trailing-whitespaces
" Clean all the trailing whitespaces in the current buffer
function! StripTrailingWhitespaces()
  " Preparation: save last search, and cursor position.
  let _s=@/
  let l = line(".")
  let c = col(".")
  " Do the business:
  %s/\s\+$//e
  " Clean up: restore previous search history, and cursor position
  let @/=_s
  call cursor(l, c)
endfunction

" }}}

" {{{ Global options

set shell=zsh           " shell for :sh
set autoread            " watch for file changes by other programs
set autowrite           " automatically save before :next and :make
set laststatus=2        " always display status line
set encoding=utf-8      " ensure proper encoding
set ttyfast             " welcome to the 20th century guys
set modelines=0         " don't care about modeline
set fileformats=unix,mac,dos " support all three newline formats
set tags=tags;/         " define tags file path
set cryptmethod="blowfish" " define strong crypt method
set noswapfile          " disable swap files

set backup              " enable backup files
set backupdir=~/.vim/tmp/backup// " backup files directory
if !isdirectory(expand(&backupdir))
  silent! call mkdir(expand(&backupdir), "p")
endif

set undofile            " enable undo files
set undolevels=1000     " number of undo level
set undoreload=10000    " number of lines to save for undo
set undodir=~/.vim/tmp/undo// " undo files directory
if !isdirectory(expand(&undodir))
  silent! call mkdir(expand(&undodir), "p")
endif

set spellfile=~/.vim/spell/en.utf-8.add " enable spell file

" }}}

" {{{ User Interface

set timeoutlen=500      " time to wait when a part of a maped sequence is typped
set ttimeoutlen=0       " instant insert mode exit using escape
set matchtime=3         " tenths of second to show the matching bracket
set cmdheight=1         " explicitly set the command line height
set showcmd             " show (partial) command in the last line of the screen
set scrolloff=8         " keep at least 8 lines after the cusor when scrolling
set sidescrolloff=10    " (same as above for side scrolling)
set lazyredraw          " only redraw when needed
set nolist              " hide invisible characters
set wrap                " split the line if it is too long
set shortmess=aoOsI     " disable vim welcome message / enable shorter messages
set cursorline          " highlight cursor line
set wildmenu            " better command line completion menu
set wildmode=list:longest,list,full " `-> better
set wildignore+=*.o,*.so,*.a,*.dylib,*.pyc  " ignore compiled files
set wildignore+=*.zip,*.gz,*.xz,*.tar       " ignore compressed files
set wildignore+=.*.sw*,*~                   " ignore temporary files
set tabpagemax=20       " allow lots of tabs

" }}}

" {{{ Text editing && Search behavior

set backspace=2         " fix backspace (on some OS/term)
set ignorecase          " ignore case when searching
set smartcase           "  `-> except if there is one uppercase character
set incsearch           " show matches as soon as possible
set wrapscan            " searches wrap around the end of the file
set diffopt=filler,iwhite " ignore all whitespace and sync while differentiates
set showmatch           " show the matching bracket when inserting
set completeopt=menuone,preview " more complete autocompletion
set nostartofline       " leave my cursor position alone!
set foldmethod=manual   " ensure that foldmethod is manual
set virtualedit=block   " allow the cursor to go in to 'invalid' places
set wrap linebreak textwidth=0 " disable autowrap
set history=1000        " increase history size
set selection=inclusive " cursor is in selection
set gdefault            " default substitute g flag
autocmd VimEnter * set hlsearch " highlight last search matches
autocmd InsertEnter * :setlocal nohlsearch " disable search highlighting in insert mode
autocmd InsertLeave * :setlocal hlsearch

" spell checker
set spelllang=en        " configure spell language
highlight clear SpellBad
highlight clear SpellCap
highlight clear SpellLocal
highlight clear SpellRare

" format option stuff (see :help fo-table)
set fo=cro
silent! set fo+=j " not compatible with all vim versions

" Highlight trailing whitespaces
highlight TrailingWhitespace ctermbg=darkyellow
match TrailingWhitespace /\s\+$/

" clean trailing whitespaces on file saving
autocmd BufWritePre * :call StripTrailingWhitespaces()

" remember last position in file
autocmd BufReadPost * if line("'\"") > 0 && line("'\"") <= line("$") | exe "normal g'\"" | endif

" }}}

" {{{ Indentation / Tabulations

set autoindent          " auto-indentation (most of time override by plugins)
set smarttab            " insert shiftwidth spaces instead of tabs
set expandtab           " replace tabs by spaces
autocmd VimEnter * set shiftwidth=2  " n spaces when using <Tab>
autocmd VimEnter * set softtabstop=2 " n spaces when using <Tab>
autocmd VimEnter * set tabstop=2     " n spaces when using <Tab>
set hidden              " when a tab is closed, do not delete the buffer

" }}}

" {{{ Errors

" turn off error bells
set noerrorbells
set novisualbell
set t_vb=

" }}}

" {{{ Binds

" easy switch between tabs
nnoremap <silent> <S-H> gT
nnoremap <silent> <S-L> gt

" up and down are more logical with g
nnoremap <silent> j gj
vnoremap <silent> j gj
nnoremap <silent> k gk
vnoremap <silent> k gk

" center on each search result
nnoremap <silent> n nzz
nnoremap <silent> <S-N> Nzz

" define leading key
let mapleader = '\'

" quickly edit/reload the vimrc file
nnoremap <silent> <Leader>ve :e $MYVIMRC<CR>
nnoremap <silent> <Leader>vs :source $MYVIMRC<CR>

" hide last search matches
nnoremap <silent> <Space> :nohlsearch<CR>

" use `,d`  `,D` `,x` `,X` to delete without altering the yanked stack
nnoremap <silent> <Leader>d "_d
vnoremap <silent> <Leader>d "_d
nnoremap <silent> <Leader>D "_D
vnoremap <silent> <Leader>D "_D
nnoremap <silent> <Leader>x "_x
vnoremap <silent> <Leader>x "_x
nnoremap <silent> <Leader>X "_X
vnoremap <silent> <Leader>X "_X

" copy from the cursor to the end of line using Y
nnoremap <silent> Y y$

" man key on M
nnoremap <silent> M K

" keep the cursor in place while joining lines
nnoremap <silent> J myJ`y

" split line with K
nnoremap <silent> K i<CR><Esc>^mzgk:silent! s/\v +$//<CR>:nohlsearch<CR>`z

" insert blank lines without entering insert mode
nnoremap <silent> go o<Esc>
nnoremap <silent> gO O<Esc>

" disable annoying keys
map <silent> <F1> <Nop>
imap <silent> <F1> <Nop>
map <silent> Q <Nop>

" also bind `jj` to leave insert/command mode
inoremap <silent> jj <C-C>

" useful insert mode binds
inoremap <silent> II <C-O>I
inoremap <silent> AA <C-O>A
inoremap <silent> CC <C-O>C
inoremap <silent> OO <C-O>O
inoremap <silent> <C-O><C-O> <C-O>o
inoremap <silent> JJ <C-O>J

" buffer
nnoremap <silent> <leader>bq :bdelete<CR>

" tab
nnoremap <silent> <leader>tc :tabnew<CR>
nnoremap <silent> <leader>tq :tabclose<CR>

" }}}

" {{{ Language specific configuration

autocmd FileType c,cpp call LoadCConfiguration()
function! LoadCConfiguration()
  set omnifunc=ccomplete#Complete
endfunction

" CSS
autocmd FileType css call LoadCSSConfiguration()
function! LoadCSSConfiguration()
  setl omnifunc=csscomplete#CompleteCSS
  setl iskeyword+=-
endfunction

" Git commit
autocmd FileType gitcommit call LoadGitCommitConfiguration()
function! LoadGitCommitConfiguration()
  setl spell
  highlight SpellBad cterm=underline
  highlight SpellCap cterm=underline
  highlight SpellLocal cterm=underline
  highlight SpellRare cterm=underline
endfunction

" JavaScript
autocmd FileType javascript call LoadJavaScriptConfiguration()
function! LoadJavaScriptConfiguration()
  setl omnifunc=javascriptcomplete#CompleteJS
  setl shiftwidth=4
  setl softtabstop=4
  setl tabstop=4
endfunction

" HTML
autocmd FileType html call LoadHTMLConfiguration()
function! LoadHTMLConfiguration()
  setl omnifunc=htmlcomplete#CompleteTags
  setl iskeyword+=-
endfunction

" Markdown
autocmd FileType markdown call LoadMarkdownConfiguration()
function! LoadMarkdownConfiguration()
  setl omnifunc=htmlcomplete#CompleteTags
  setl formatoptions=tcroqn2 comments=n:>
  setl spell
  highlight SpellBad cterm=underline
  highlight SpellCap cterm=underline
  highlight SpellLocal cterm=underline
  highlight SpellRare cterm=underline
endfunction

" PHP
autocmd FileType php call LoadPHPConfiguration()
function! LoadPHPConfiguration()
  setl omnifunc=phpcomplete#CompletePHP
  setl iskeyword-=$
  setl iskeyword+=:
  setl shiftwidth=4
  setl softtabstop=4
  setl tabstop=4
endfunction

" Python
autocmd FileType python call LoadPythonConfiguration()
function! LoadPythonConfiguration()
  setl omnifunc=pythoncomplete#Complete
  setl shiftwidth=4
  setl softtabstop=4
  setl tabstop=4
endfunction

" XML
autocmd FileType xml call LoadXMLConfiguration()
function! LoadXMLConfiguration()
  setl omnifunc=xmlcomplete#CompleteTags
endfunction

" text files
autocmd FileType text call LoadMarkdownConfiguration()
function! LoadMarkdownConfiguration()
  setl formatoptions=tcroqn2
  setl spell
  highlight SpellBad cterm=underline
  highlight SpellCap cterm=underline
  highlight SpellLocal cterm=underline
  highlight SpellRare cterm=underline
endfunction

" }}}

" {{{ Plugins extra-configuration

" ack.vim
let g:ack_autoclose = 1 " automatically closing the quickfix window

" buffergator
let g:buffergator_suppress_keymaps = 1 " delete default keymaps
let g:buffergator_viewport_split_policy = 'L' " split on the bottom of the screen
nnoremap <silent> <Leader>be :BuffergatorToggle<CR>

" CtrlP
let g:ctrlp_map = '<Leader>fo'
let g:ctrlp_custom_ignore = {
  \ 'dir':  '\v[\/]\.(git|hg|svn)$',
  \ } " will be ignored in completion (the `wildignore` option is considered before these pattenrs)
let g:ctrlp_switch_buffer = 't' " if the file exists in a buffer in the current tab, jump to it
let g:ctrlp_working_path_mode = 'ra' " the nearest ancestor containing a SCM configuration file (.git, ...)
let g:ctrlp_max_files = 1000 " avoid lag if launched in a top directory (~ for example)
let g:ctrlp_max_depth = 10 " same as above
let g:ctrlp_clear_cache_on_exit = 0 " keep cache across sessions
let g:ctrlp_show_hidden = 1 " search for hidden files
let g:ctrlp_follow_symlinks = 1 " follow symlinks (but prevent infinite loops)
nnoremap <silent> <Leader>bo :CtrlPBuffer<CR>

" easymotion
let g:EasyMotion_leader_key = '<Leader><Leader>'

" easytag
"let g:easytags_by_filetype = 1 " separate tag files for each languages (https://github.com/xolox/vim-easytags/issues/60)
let g:easytags_include_members = 1 " more complete tag files for C++ and Java
let g:easytags_resolve_links = 1 " follow symlinks
let g:easytags_python_enabled = 1 " use Python for faster syntax highlighting

" gundo
let g:gundo_width = 40 " gundo pane width
let g:gundo_preview_height = 40 " preview height
let g:gundo_preview_bottom = 1 " preview on file bottom (not in pane)
let g:gundo_help = 0 " disable help in gundo pane
let g:gundo_close_on_revert = 1 " automatically close the gundo pane on revert
nnoremap <Leader>ue :GundoToggle<CR>

" multiple cursors
vnoremap <silent> <Leader>m :MultipleCursorsFind<Space>

" narrowregion
let g:nrrw_rgn_nohl = 1 " disable highlighting in the main window while isolating code
noremap <silent> <Leader>r :NarrowRegion<CR>

" nerdtree
let NERDTreeShowHidden = 1 " show hidden files
let NERDTreeQuitOnOpen = 1 " close tree when opening a file
let NERDTreeWinSize = 40 " tree width
let NERDTreeMinimalUI = 1 " hide superfluous stuff
nnoremap <silent> <Leader>fe :NERDTreeToggle<CR>

" neocomplcache
let g:acp_enableAtStartup = 0 " Disable AutoComplPop.
let g:neocomplcache_enable_at_startup = 1 " Use neocomplcache.
let g:neocomplcache_enable_smart_case = 1 " Use smartcase.
if !exists('g:neocomplcache_omni_patterns') | let g:neocomplcache_omni_patterns = {} | endif
let g:neocomplcache_omni_patterns.php = '[^. \t]->\h\w*\|\h\w*::'
let g:neocomplcache_omni_patterns.c = '[^.[:digit:] *\t]\%(\.\|->\)'
let g:neocomplcache_omni_patterns.cpp = '[^.[:digit:] *\t]\%(\.\|->\)\|\h\w*::'
inoremap <expr> <C-Y> pumvisible() ? "\<C-Y>\<C-Y>" : "\<C-Y>"
inoremap <expr> <C-E> pumvisible() ? "\<C-Y>\<C-E>" : "\<C-E>"
inoremap <expr> <CR> pumvisible() ? "\<C-Y>\<CR>" : "\<CR>"

" php indent
let g:PHP_vintage_case_default_indent = 1 " change indentation method

" powerline
set noshowmode " hide the duplicate mode in bottom status bar

" sparkup
let g:sparkupExecuteMapping = '<C-H>'
let g:sparkupNextMapping = '<C-F>'

" syntastic
let g:syntastic_mode_map = { 'mode': 'passive' } " passive
let g:syntastic_check_on_wq = 0 " disable on save
let g:syntastic_always_populate_loc_list = 1 " stick any errors in the loclist
let g:syntastic_auto_loc_list = 1 " open loclist on error / else close it
let g:syntastic_c_compiler_options = "-Wall -Wextra"
let g:syntastic_cpp_checkers = [ 'cpplint' ]
nnoremap <silent> <Leader>c :SyntasticCheck<CR>
nnoremap <silent> <Leader>C :SyntasticToggleMode<CR>

" tabular
nnoremap <silent> <Leader>a :Tabularize /
vnoremap <silent> <Leader>a :Tabularize /

" tagbar
let g:tagbar_autofocus = 1 " focus tagbar opened
let g:tagbar_autoclose = 1 " close tagbar when opening a tag
let g:tagbar_show_visibility = 1 " show public/private/protected
let g:tagbar_compact = 1 " hide superfluous stuff
let g:tagbar_width = 40 " set tagbar width
let g:tagbar_left = 1 " set tagbar pane onthe left side
nnoremap <silent> <Leader>te :TagbarToggle<CR>

" winresizer
let g:winresizer_start_key = '<C-W><C-W>'

" }}}
